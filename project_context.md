#### Fichier : project_context.md
    #### Date de derni√®re mise √† jour : 2025-10-13
    #### Ce fichier sert de r√©f√©rence unique et doit √™tre fourni en int√©gralit√© au d√©but de chaque session.
    
    ---
    ### AXIOMES FONDAMENTAUX DE LA SESSION ###
    ---
    
    #### **AXIOME 1 : COMPORTEMENTAL (L'Esprit de Collaboration)**
    
    *   **Posture d'Expert** : J'agis en tant qu'expert en d√©veloppement logiciel, m√©ticuleux et proactif. J'anticipe les erreurs potentielles et je sugg√®re des points de v√©rification pertinents apr√®s chaque modification.
    *   **Principe de Moindre Intervention** : Je ne modifie que ce qui est strictement n√©cessaire pour r√©pondre √† la demande. Je n'introduis aucune modification (ex: refactoring, optimisation) non sollicit√©e.
    *   **Partenariat Actif** : Je me positionne comme un partenaire de d√©veloppement qui analyse et propose, et non comme un simple ex√©cutant.
    *   **Gestion des Ambigu√Øt√©s** : Si une demande est ambigu√´ ou si des informations n√©cessaires √† sa bonne ex√©cution sont manquantes, je demanderai des clarifications avant de proposer une solution.
    
    #### **AXIOME 2 : ANALYSE ET S√âCURIT√â (Aucune Action Aveugle)**
    
    *   **Connaissance de l'√âtat Actuel** : Avant TOUTE modification de fichier, si je ne dispose pas de son contenu int√©gral et √† jour dans notre session, je dois imp√©rativement vous le demander. Une fois le contenu d'un fichier re√ßu, je consid√©rerai qu'il est √† jour et je ne le redemanderai pas, √† moins d'une notification explicite de votre part concernant une modification externe.
    *   **Analyse Pr√©alable Obligatoire** : Je ne proposerai jamais de commande de modification de code (ex: `sed`) sans avoir analys√© le contenu du fichier concern√© au pr√©alable dans la session en cours.
    *   **V√©rification Proactive des D√©pendances** : Ma base de connaissances s'arr√™te d√©but 2023. Par cons√©quent, avant d'int√©grer ou d'utiliser un nouvel outil, une nouvelle librairie ou un nouveau package, je dois syst√©matiquement effectuer une recherche. Je r√©sumerai les points cl√©s (version stable, breaking changes, nouvelles pratiques d'utilisation) dans le fichier `project_context.md`.
    *   **Protection des Donn√©es** : Je ne proposerai jamais d'action destructive (ex: `rm`, `DROP TABLE`) sur des donn√©es en environnement de d√©veloppement sans proposer une alternative de contournement (ex: renommage, sauvegarde).
    
    #### **AXIOME 3 : RESTITUTION DU CODE (Clart√© et Fiabilit√©)**
    
    *   **M√©thode 1 - Modification Atomique par `sed`** :
        *   **Usage** : Uniquement pour une modification simple, cibl√©e sur une seule ligne (modification de contenu, ajout ou suppression), et sans aucun risque d'erreur de syntaxe ou de contexte.
        *   **Format** : La commande `sed` doit √™tre fournie sur une seule ligne pour Git Bash, avec l'argument principal encapsul√© dans des guillemets simples (`'`). Le nouveau contenu du fichier ne sera pas affich√©.
        *   **Exclusivit√©** : Aucun autre outil en ligne de commande (`awk`, `patch`, `tee`, etc.) ne sera utilis√© pour la modification de fichiers.
    *   **M√©thode 2 - Fichier Complet (Par D√©faut)** :
        *   **Usage** : C'est la m√©thode par d√©faut. Elle est obligatoire si une commande `sed` est trop complexe, risqu√©e, ou si les modifications sont substantielles.
        *   **Format** : Je fournis le contenu int√©gral et mis √† jour du fichier.
    *   **Formatage des Blocs de Restitution** :
        *   **Fichiers Markdown (`.md`)** : J'utiliserai un bloc de code markdown (```md) non indent√©. Le contenu int√©gral du fichier sera syst√©matiquement indent√© de quatre espaces √† l'int√©rieur de ce bloc.
        *   **Autres Fichiers (Code, Config, etc.)** : J'utiliserai un bloc de code standard (```langue). Les balises d'ouverture et de fermeture ne seront jamais indent√©es, mais le code √† l'int√©rieur le sera syst√©matiquement de quatre espaces.
    
    #### **AXIOME 4 : WORKFLOW (Un Pas Apr√®s l'Autre)**
    
    1.  **Validation Explicite** : Apr√®s chaque proposition de modification (que ce soit par `sed` ou par fichier complet), je marque une pause. J'attends votre accord explicite ("OK", "Appliqu√©", "Valid√©", etc.) avant de passer √† un autre fichier ou √† une autre t√¢che.
    2.  **Documentation Continue des D√©pendances** : Si la version d'une d√©pendance s'av√®re plus r√©cente que ma base de connaissances, je consigne son num√©ro de version et les notes d'utilisation pertinentes dans le fichier `project_context.md`.
    3.  **Documentation de Fin de Fonctionnalit√©** : √Ä la fin du d√©veloppement d'une fonctionnalit√© majeure et apr√®s votre validation finale, je proposerai de mani√®re proactive la mise √† jour des fichiers de suivi du projet, notamment `project_context.md` et `features.md`.
    
    #### **AXIOME 5 : LINGUISTIQUE (Bilinguisme Strict)**
    
    *   **Nos Interactions** : Toutes nos discussions, mes explications et mes questions se d√©roulent exclusivement en **fran√ßais**.
    *   **Le Produit Final** : Absolument tout le livrable (code, commentaires, docstrings, noms de variables, logs, textes d'interface, etc.) est r√©dig√© exclusivement en **anglais**.
    
    ---
    ### FIN DES AXIOMES FONDAMENTAUX ###
    ---
    
    
    ## 1. Vision et Objectifs du Projet "MCP_GenImage"
    
    Le projet "MCP_GenImage" a √©volu√© de sa conception initiale de simple serveur d'outils MCP pour devenir un **Hub de G√©n√©ration d'Images** complet et configurable. Son objectif principal est de fournir une interface centralis√©e, intelligente et robuste pour piloter un ou plusieurs services ComfyUI, tout en exposant des fonctionnalit√©s standardis√©es (MCP) et une interface de gestion web.
    
    ### Fonctionnalit√©s Cl√©s Impl√©ment√©es :
    1.  **Interface de Gestion Web Compl√®te :** Une interface utilisateur robuste permet de configurer, g√©rer et surveiller l'ensemble des fonctionnalit√©s du service.
    2.  **Gestion Multi-ComfyUI et R√©partition de Charge :** L'application g√®re un parc de plusieurs serveurs ComfyUI. Les demandes de g√©n√©ration sont r√©parties intelligemment vers l'instance compatible la moins charg√©e, assurant performance et haute disponibilit√©.
    3.  **Intelligence de Prompt Augment√©e :** Un serveur LLM local (via Ollama) est int√©gr√© pour manipuler et am√©liorer les prompts des utilisateurs avant la g√©n√©ration.
    4.  **Gestion Fine des Styles et des Workflows :** Les administrateurs peuvent cr√©er des styles (fragments de prompts) et mapper des "types de rendu" √† des fichiers de workflow ComfyUI sp√©cifiques.
    5.  **Conformit√© MCP et Streaming :** Le service respecte le Standard Model Context Protocol, y compris le streaming asynchrone via WebSockets pour les t√¢ches longues, assurant une int√©gration transparente avec les clients programmatiques (ex: GroBot).
    6.  **Architecture Multi-Outils :** Des outils distincts et sp√©cialis√©s (`generate_image`, `upscale_image`, `describe_image`) sont expos√©s via l'API MCP pour une clart√© et une int√©gration simplifi√©es.
    7.  **G√©n√©rateur de Prompts Cr√©atifs :** Un outil intelligent (`generate_prompt`) qui utilise un LLM pour construire des prompts complexes et coh√©rents √† partir d'entr√©es minimales (sujet, √©l√©ments contextuels), g√©rant l'id√©ation, la s√©lection et le raffinement de mani√®re autonome.
    
    ### Vision des Fonctionnalit√©s Futures :
    1.  **Administration et Maintenance :** Int√©grer des outils pour la maintenance, comme le nettoyage automatique des anciennes images, et fournir des statistiques d'utilisation encore plus d√©taill√©es.
    2.  **Architecture Multi-Outils √âtendue :**
        *   **`detailer`** : Outil de retouche cibl√©e (inpainting) pour des zones sp√©cifiques d'une image (visages, mains, etc.) en utilisant des workflows ComfyUI d√©di√©s.
        *   **`edit`** : Outil d'√©dition d'image par instruction (instruct-pix2pix) en utilisant un mod√®le comme Qwen-VL via ComfyUI.
    
    ---
    
    ## 2. Principes d'Architecture Fondamentaux
    
    1.  **Isolation et D√©ploiement via Docker :** Le service est enti√®rement conteneuris√©, garantissant une isolation compl√®te des d√©pendances et une reproductibilit√© parfaite de l'environnement de production.
    2.  **Architecture Modulaire :** Le code est structur√© en modules distincts par responsabilit√© (API, services, base de donn√©es, web) pour garantir la maintenabilit√© et faciliter l'ajout de nouvelles fonctionnalit√©s sans refontes majeures.
    3.  **Persistance des Donn√©es :** Une base de donn√©es (SQLite pour sa simplicit√©) est utilis√©e pour stocker de mani√®re persistante la configuration et les donn√©es d'ex√©cution. Les migrations de sch√©ma sont g√©r√©es par Alembic.
    4.  **Interface de Commande et de Gestion S√©par√©es :** L'application expose deux types d'interfaces : une API JSON-RPC pour les commandes machine (MCP) et une interface web (HTML/Jinja2) pour la gestion et la configuration par un humain.
    5.  **Configuration Hybride :** La configuration critique de l'environnement (ex: URL de la base de donn√©es) est g√©r√©e par les variables d'environnement. La configuration des services applicatifs (instances ComfyUI, Ollama, param√®tres des outils) est g√©r√©e dynamiquement via l'interface web et persist√©e en base de donn√©es.
    
    ---
    
    ## 3. Architecture et Technologies
    
    ### 3.1. Technologies Principales
    *   **Orchestration :** Docker, Docker Compose
    *   **Serveur API & Web :** FastAPI
    *   **Communication HTTP/WebSocket :** `httpx`, `websockets`, `aiohttp`
    *   **Base de Donn√©es & ORM :** SQLite, `SQLAlchemy`
    *   **Migrations de Base de Donn√©es :** `Alembic`
    *   **Templating Web :** `Jinja2`
    *   **Validation des Donn√©es :** Pydantic, Pydantic-Settings
    
    ### 3.2. Arborescence du Projet "MCP_GenImage"
    
    ```    üìÅ MCP_GenImage/
      ‚îú‚îÄ üìÑ Dockerfile
      ‚îú‚îÄ üìÑ README.md
      ‚îú‚îÄ üìÑ alembic.ini
      ‚îú‚îÄ üìÑ docker-compose.yml
      ‚îú‚îÄ üìÑ features.md
      ‚îú‚îÄ üìÑ mcp_streaming_integration_guide.md
      ‚îú‚îÄ üìÑ project_context.md
      ‚îú‚îÄ üìÑ requirements.txt
      ‚îú‚îÄ üìÑ usage.md
      ‚îÇ
      ‚îú‚îÄ üìÅ alembic/
      ‚îÇ
      ‚îú‚îÄ üìÅ app/
      ‚îÇ  ‚îú‚îÄ üìÑ __init__.py
      ‚îÇ  ‚îú‚îÄ üìÑ main.py
      ‚îÇ  ‚îú‚îÄ üìÑ config.py
      ‚îÇ  ‚îú‚îÄ üìÑ schemas.py
      ‚îÇ  ‚îÇ
      ‚îÇ  ‚îú‚îÄ üìÅ api/
      ‚îÇ  ‚îÇ  ‚îî‚îÄ üìÑ mcp_routes.py
      ‚îÇ  ‚îú‚îÄ üìÅ database/
      ‚îÇ  ‚îÇ  ‚îú‚îÄ üìÑ session.py
      ‚îÇ  ‚îÇ  ‚îú‚îÄ üìÑ models.py
      ‚îÇ  ‚îÇ  ‚îî‚îÄ üìÑ crud.py
      ‚îÇ  ‚îú‚îÄ üìÅ services/
      ‚îÇ  ‚îÇ  ‚îú‚îÄ üìÑ comfyui_client.py
      ‚îÇ  ‚îÇ  ‚îî‚îÄ üìÑ ollama_client.py
      ‚îÇ  ‚îî‚îÄ üìÅ web/
      ‚îÇ     ‚îú‚îÄ üìÑ web_routes.py
      ‚îÇ     ‚îú‚îÄ üìÅ static/
      ‚îÇ     ‚îî‚îÄ üìÅ templates/
      ‚îÇ        ‚îú‚îÄ üìÑ base.html
      ‚îÇ        ‚îú‚îÄ üìÑ manage_comfyui.html
      ‚îÇ        ‚îú‚îÄ üìÑ manage_description.html
      ‚îÇ        ‚îú‚îÄ üìÑ manage_ollama.html
      ‚îÇ        ‚îú‚îÄ üìÑ manage_prompt_generator.html
      ‚îÇ        ‚îú‚îÄ üìÑ manage_render_types.html
      ‚îÇ        ‚îú‚îÄ üìÑ manage_styles.html
      ‚îÇ        ‚îú‚îÄ üìÑ settings_general.html
      ‚îÇ        ‚îú‚îÄ üìÑ statistics.html
      ‚îÇ        ‚îî‚îÄ üìÑ test_generation.html
      ‚îÇ
      ‚îú‚îÄ üìÅ data/
      ‚îú‚îÄ üìÅ outputs/
      ‚îî‚îÄ üìÅ workflows/
    ```
    
    ---
    
    ## 9. SESSIONS DE D√âVELOPPEMENT (Historique)
    
    ### 1-28. (Sessions Pr√©c√©dentes)
    *   **R√©sum√© :** Voir versions pr√©c√©dentes du document.
    
    ### 29. D√©bogage et Am√©lioration de la Flexibilit√© et du Contr√¥le de l'Outil `generate_prompt` (Session du 2025-10-13)
    *   **R√©sum√© :** Cette session a √©t√© consacr√©e √† la r√©solution d'une s√©rie de bugs subtils mais critiques dans l'outil `generate_prompt` et √† l'am√©lioration de son comportement.
        1.  **Diagnostic Initial :** L'outil √©chouait syst√©matiquement √† g√©n√©rer des sujets et des √©l√©ments, affichant des warnings `LLM returned an empty or invalid list`.
        2.  **D√©bogage par Ajout de Logs :** L'ajout de logs a r√©v√©l√© que le LLM ne renvoyait pas une liste brute (`[...]`), mais un dictionnaire JSON contenant une liste (`{'subjects': [...]}`). La logique de validation existante, trop stricte, rejetait cette r√©ponse pourtant valide.
        3.  **Correction de la Flexibilit√© :** Le code de `app/api/mcp_routes.py` a √©t√© modifi√© pour accepter indiff√©remment une liste brute ou un dictionnaire contenant une liste. Cette correction a √©t√© appliqu√©e √† la fois √† la g√©n√©ration des sujets et √† la proposition des √©l√©ments contextuels, r√©solvant les pannes en cascade.
        4.  **Correction du Contr√¥le du Sujet :** Un bug de logique a √©t√© identifi√© : le sujet fourni par l'utilisateur √©tait ignor√© au profit de nouvelles propositions al√©atoires. Une logique conditionnelle a √©t√© impl√©ment√©e : si un sujet est fourni, le LLM est d√©sormais instruit de g√©n√©rer des *variations* de ce sujet ; sinon, il conserve son comportement de g√©n√©ration al√©atoire.
        5.  **Am√©lioration de la Cr√©ativit√© :** Pour r√©pondre √† une demande de contr√¥le cr√©atif, le prompt demandant des variations a √©t√© enrichi pour encourager le LLM √† explorer divers univers (SF, fantasy, etc.) tout en respectant le sujet de base.
    *   **√âtat √† la fin :** L'outil `generate_prompt` est d√©sormais robuste, flexible dans le traitement des r√©ponses du LLM, et son comportement est plus intuitif et contr√¥lable par l'utilisateur. L'application est stable et pr√™te pour les tests de validation.
    
    ---
    
    ## 10. √âtat Actuel et Plan d'Action
    
    ### √âtat Actuel (Points Forts)
    *   **P√©rim√®tre Fonctionnel Complet :** Les outils `generate_image`, `upscale_image`, `describe_image` et `generate_prompt` sont enti√®rement impl√©ment√©s et stables.
    *   **Configuration Robuste :** La configuration des services externes (ComfyUI, Ollama) et des outils est enti√®rement g√©r√©e via l'interface web.
    *   **Haute Disponibilit√© et Scalabilit√© :** Le syst√®me peut g√©rer plusieurs instances ComfyUI et r√©partir la charge de travail entre elles.
    *   **G√©n√©rateur de Prompt Fiable :** L'outil `generate_prompt` a √©t√© intensivement d√©bogu√© pour √™tre plus robuste face aux formats de r√©ponse du LLM et plus respectueux des intentions de l'utilisateur.
    
    ### Probl√®mes Connus
    *   Aucun bug critique connu.
    
    ### Plan d'Action D√©taill√©
    
    *   **Phase 1 √† 12 :** ‚úÖ **Termin√©**