{% extends "base.html" %}

{% block title %}{{ title }} - MCP GenImage{% endblock %}

{% block content %}
<style>
    .actions form,
    .actions .test-btn {
        display: inline-block;
        margin-right: 5px;
    }

    .status-dot {
        height: 12px;
        width: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }

    .status-success {
        background-color: #8dff8d;
    }

    .status-fail {
        background-color: #ff8a8a;
    }

    .status-pending {
        background-color: #f0e68c;
    }
</style>

<div class="container">
    <h1>{{ title }}</h1>

    <h2>Existing Instances</h2>
    <table>
        <thead>
            <tr>
                <th>Status</th>
                <th>Name</th>
                <th>Base URL</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for instance in instances %}
            <tr>
                <td>
                    {% if instance.is_active %}
                    <span style="color: #8dff8d;">● Active</span>
                    {% else %}
                    <span style="color: #ff8a8a;">○ Inactive</span>
                    {% endif %}
                </td>
                <td>{{ instance.name }}</td>
                <td>{{ instance.base_url }}</td>
                <td class="actions">
                    <button type="button" class="btn btn-secondary test-btn" data-url="{{ instance.base_url }}"
                        data-id="{{ instance.id }}">
                        Test
                    </button>
                    <span id="test-result-{{ instance.id }}" class="status-dot" style="display: none;"></span>

                    <button type="button" class="btn btn-secondary edit-btn" data-id="{{ instance.id }}"
                        data-name="{{ instance.name }}" data-base-url="{{ instance.base_url }}">
                        Edit
                    </button>
                    <form action="/settings/ollama/toggle-active/{{ instance.id }}" method="post">
                        <button type="submit" class="btn btn-secondary">
                            {{ 'Deactivate' if instance.is_active else 'Activate' }}
                        </button>
                    </form>
                    <form action="/settings/ollama/delete/{{ instance.id }}" method="post"
                        onsubmit="return confirm('Are you sure you want to delete this server instance?');">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" style="text-align: center;">No Ollama instances configured.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="form-section">
        <h2 id="form-title">Add New Ollama Instance</h2>
        <form id="instance-form" action="/settings/ollama/add" method="post">
            <div class="form-group">
                <label for="name">Instance Name</label>
                <input type="text" id="name" name="name" required placeholder="e.g., LLaVA Server">
            </div>
            <div class="form-group">
                <label for="base_url">Server Base URL</label>
                <input type="text" id="base_url" name="base_url" required
                    placeholder="e.g., http://host.docker.internal:11434">
            </div>
            <button id="submit-btn" type="submit" class="btn btn-primary">Add Instance</button>
            <button id="cancel-btn" type="button" class="btn btn-secondary" style="display: none;">Cancel Edit</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('instance-form');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const nameInput = document.getElementById('name');
        const baseUrlInput = document.getElementById('base_url');

        function resetForm() {
            form.reset();
            form.action = '/settings/ollama/add';
            formTitle.textContent = 'Add New Ollama Instance';
            submitBtn.textContent = 'Add Instance';
            cancelBtn.style.display = 'none';
        }

        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', () => {
                form.action = `/settings/ollama/update/${button.dataset.id}`;
                formTitle.textContent = 'Edit Ollama Instance';
                submitBtn.textContent = 'Update Instance';
                cancelBtn.style.display = 'inline-block';
                nameInput.value = button.dataset.name;
                baseUrlInput.value = button.dataset.baseUrl;
                form.scrollIntoView({ behavior: 'smooth' });
            });
        });

        cancelBtn.addEventListener('click', resetForm);

        document.querySelectorAll('.test-btn').forEach(button => {
            button.addEventListener('click', async () => {
                const instanceId = button.dataset.id;
                const resultDot = document.getElementById(`test-result-${instanceId}`);
                resultDot.style.display = 'inline-block';
                resultDot.className = 'status-dot status-pending';
                resultDot.title = 'Testing...';

                try {
                    const response = await fetch('/api/v1/ollama/list-models', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ollama_api_url: button.dataset.url })
                    });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.detail || 'Test failed');
                    }
                    resultDot.className = 'status-dot status-success';
                    resultDot.title = 'Connection successful!';
                } catch (error) {
                    resultDot.className = 'status-dot status-fail';
                    resultDot.title = `Error: ${error.message}`;
                }
            });
        });
    });
</script>
{% endblock %}