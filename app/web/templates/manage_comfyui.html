{% extends "base.html" %}

{% block title %}{{ title }} - MCP GenImage{% endblock %}

{% block content %}
<style>
    .actions form {
        display: inline-block;
        margin-right: 5px;
    }

    .checkbox-group {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #444;
        padding: 10px;
        border-radius: 4px;
        background-color: #333;
    }

    .checkbox-group label {
        display: block;
        margin-bottom: 5px;
    }
</style>

<div class="container">
    <h1>{{ title }}</h1>

    <h2>Existing Instances</h2>
    <table>
        <thead>
            <tr>
                <th>Status</th>
                <th>Name</th>
                <th>Base URL</th>
                <th>Compatible Render Types</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for instance in instances %}
            <tr>
                <td>
                    {% if instance.is_active %}
                    <span style="color: #8dff8d;">● Active</span>
                    {% else %}
                    <span style="color: #ff8a8a;">○ Inactive</span>
                    {% endif %}
                </td>
                <td>{{ instance.name }}</td>
                <td>{{ instance.base_url }}</td>
                <td>{{ instance.compatible_render_types | map(attribute='name') | join(', ') }}</td>
                <td class="actions">
                    <button type="button" class="btn btn-secondary edit-btn" data-id="{{ instance.id }}"
                        data-name="{{ instance.name }}" data-base-url="{{ instance.base_url }}"
                        data-compatible-ids="{{ instance.compatible_render_types | map(attribute='id') | list }}">
                        Edit
                    </button>
                    <form action="/settings/comfyui/toggle-active/{{ instance.id }}" method="post">
                        <button type="submit" class="btn btn-secondary">
                            {{ 'Deactivate' if instance.is_active else 'Activate' }}
                        </button>
                    </form>
                    <form action="/settings/comfyui/delete/{{ instance.id }}" method="post"
                        onsubmit="return confirm('Are you sure you want to delete this server instance?');">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align: center;">No ComfyUI instances configured. The service will not be
                    able to generate images.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="form-section">
        <h2 id="form-title">Add New ComfyUI Instance</h2>
        <form id="instance-form" action="/settings/comfyui/add" method="post">
            <div class="form-group">
                <label for="name">Instance Name</label>
                <input type="text" id="name" name="name" required placeholder="e.g., Main Server">
            </div>
            <div class="form-group">
                <label for="base_url">Server Base URL</label>
                <input type="text" id="base_url" name="base_url" required
                    placeholder="e.g., http://192.168.1.10:9000 or http://host.docker.internal:9000">
            </div>

            <div class="form-group">
                <label>Compatible Render Types</label>
                <div class="checkbox-group">
                    {% for rt in all_render_types %}
                    <label>
                        <input type="checkbox" name="compatible_render_types" value="{{ rt.id }}">
                        {{ rt.name }}
                    </label>
                    {% else %}
                    <p>No render types defined yet. Please add a Render Type first.</p>
                    {% endfor %}
                </div>
            </div>

            <button id="submit-btn" type="submit" class="btn btn-primary">Add Instance</button>
            <button id="cancel-btn" type="button" class="btn btn-secondary" style="display: none;">Cancel Edit</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('instance-form');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const nameInput = document.getElementById('name');
        const baseUrlInput = document.getElementById('base_url');

        function resetForm() {
            form.reset();
            form.action = '/settings/comfyui/add';
            formTitle.textContent = 'Add New ComfyUI Instance';
            submitBtn.textContent = 'Add Instance';
            cancelBtn.style.display = 'none';

            // Uncheck all render type checkboxes
            document.querySelectorAll('input[name="compatible_render_types"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function setupEditForm(button) {
            const id = button.dataset.id;
            const compatibleIds = JSON.parse(button.dataset.compatibleIds.replace(/'/g, '"'));

            form.action = `/settings/comfyui/update/${id}`;
            formTitle.textContent = 'Edit ComfyUI Instance';
            submitBtn.textContent = 'Update Instance';
            cancelBtn.style.display = 'inline-block';

            nameInput.value = button.dataset.name;
            baseUrlInput.value = button.dataset.baseUrl;

            // Handle checkboxes for compatible types
            document.querySelectorAll('input[name="compatible_render_types"]').forEach(checkbox => {
                checkbox.checked = compatibleIds.includes(parseInt(checkbox.value));
            });

            form.scrollIntoView({ behavior: 'smooth' });
        }

        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', () => setupEditForm(button));
        });

        cancelBtn.addEventListener('click', resetForm);
    });
</script>
{% endblock %}