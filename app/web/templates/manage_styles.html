{% extends "base.html" %}

{% block title %}{{ title }} - MCP GenImage{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ title }}</h1>

    <h2>Existing Styles</h2>
    <table>
        <thead>
            <tr>
                <th>Default Style</th>
                <th>Name</th>
                <th>Category</th>
                <th>Compatible Render Types</th>
                <th>Default Render Type</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for st in styles %}
            <tr>
                <td>
                    {% if st.is_default %}
                    <span title="This is a default style">âœ…</span>
                    {% endif %}
                </td>
                <td>{{ st.name }}</td>
                <td>{{ st.category }}</td>
                <td>
                    {{ st.compatible_render_types | map(attribute='name') | join(', ') }}
                </td>
                <td>
                    {{ st.default_render_type.name if st.default_render_type else 'N/A' }}
                </td>
                <td class="actions">
                    <button type="button" class="btn btn-secondary edit-btn" data-id="{{ st.id }}"
                        data-name="{{ st.name }}" data-category="{{ st.category }}"
                        data-prompt-template="{{ st.prompt_template }}"
                        data-negative-prompt-template="{{ st.negative_prompt_template }}"
                        data-compatible-ids="{{ st.compatible_render_types | map(attribute='id') | list }}"
                        data-default-id="{{ st.default_render_type.id if st.default_render_type else '' }}">Edit</button>
                    <form action="/styles/toggle-default/{{ st.id }}" method="post" style="display: inline-block;">
                        <button type="submit" class="btn btn-secondary">
                            {{ 'Unset Default' if st.is_default else 'Set as Default' }}
                        </button>
                    </form>
                    <form action="/styles/delete/{{ st.id }}" method="post"
                        onsubmit="return confirm('Are you sure you want to delete this style?');"
                        style="display: inline-block;">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align: center;">No styles found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="form-section">
        <h2 id="form-title">Add New Style</h2>
        <form id="style-form" action="/styles/add" method="post">
            <div class="form-group">
                <label for="name">Style Name</label>
                <input type="text" id="name" name="name" required placeholder="e.g., Cinematic">
            </div>
            <div class="form-group">
                <label for="category">Category</label>
                <input type="text" id="category" name="category" required placeholder="e.g., Artistic">
            </div>
            <div class="form-group">
                <label for="prompt_template">Prompt Template</label>
                <textarea id="prompt_template" name="prompt_template" required
                    placeholder="e.g., cinematic, dramatic lighting, high detail, ..."></textarea>
            </div>
            <div class="form-group">
                <label for="negative_prompt_template">Negative Prompt Template (Optional)</label>
                <textarea id="negative_prompt_template" name="negative_prompt_template"
                    placeholder="e.g., ugly, blurry, watermark, ..."></textarea>
            </div>

            <div class="form-group">
                <label>Compatible Render Types</label>
                <div class="checkbox-group">
                    {% for rt in render_types %}
                    <label>
                        <input type="checkbox" name="compatible_render_types" value="{{ rt.id }}">
                        {{ rt.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group">
                <label for="default_render_type">Default Render Type (Optional)</label>
                <select id="default_render_type" name="default_render_type">
                    <option value="">-- Not selected --</option>
                    {% for rt in render_types %}
                    <option value="{{ rt.id }}">{{ rt.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <button id="submit-btn" type="submit" class="btn btn-primary">Add Style</button>
            <button id="cancel-btn" type="button" class="btn btn-secondary" style="display: none;">Cancel</button>
        </form>
    </div>
</div>

<script>
    const form = document.getElementById('style-form');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const nameInput = document.getElementById('name');
    const categoryInput = document.getElementById('category');
    const promptTemplateInput = document.getElementById('prompt_template');
    const negativePromptTemplateInput = document.getElementById('negative_prompt_template');
    const defaultSelect = document.getElementById('default_render_type');

    function editStyle(button) {
        const id = button.dataset.id;
        const compatibleIds = JSON.parse(button.dataset.compatibleIds.replace(/'/g, '"'));
        const defaultId = button.dataset.defaultId;

        // Populate form fields
        form.action = `/styles/update/${id}`;
        formTitle.textContent = 'Edit Style';
        submitBtn.textContent = 'Update Style';
        cancelBtn.style.display = 'inline-block';

        nameInput.value = button.dataset.name;
        categoryInput.value = button.dataset.category;
        promptTemplateInput.value = button.dataset.promptTemplate;
        negativePromptTemplateInput.value = button.dataset.negativePromptTemplate;

        // Handle checkboxes for compatible types
        document.querySelectorAll('input[name="compatible_render_types"]').forEach(checkbox => {
            checkbox.checked = compatibleIds.includes(parseInt(checkbox.value));
        });

        // Handle select for default type
        defaultSelect.value = defaultId;

        // Scroll to the form for better user experience
        form.scrollIntoView({ behavior: 'smooth' });
    }

    function resetForm() {
        form.reset();
        form.action = '/styles/add';
        formTitle.textContent = 'Add New Style';
        submitBtn.textContent = 'Add Style';
        cancelBtn.style.display = 'none';
    }

    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', () => editStyle(button));
    });

    cancelBtn.addEventListener('click', resetForm);
</script>
{% endblock %}