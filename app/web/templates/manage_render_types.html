{% extends "base.html" %}

{% block title %}{{ title }} - MCP GenImage{% endblock %}

{% block head %}
{{ super() }}
<style>
    .details-box {
        background-color: #2c2c2e;
        border: 1px solid #444;
        padding: 0.5em 1em;
        border-radius: 4px;
        margin-top: 0.5em;
        max-height: 250px;
        overflow-y: auto;
    }

    .details-box summary {
        cursor: pointer;
        font-weight: bold;
    }

    .details-box p {
        margin: 0.5em 0 0 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ title }}</h1>

    <h2>Existing Render Types</h2>
    <table>
        <thead>
            <tr>
                <th>Default (Gen)</th>
                <th>Default (Upscale)</th>
                <th>Visible</th>
                <th>Name</th>
                <th>Mode</th>
                <th>Workflow Filename</th>
                <th>Prompt Examples</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for rt in render_types %}
            <tr>
                <td>{% if rt.is_default_for_generation %}‚úÖ{% endif %}</td>
                <td>{% if rt.is_default_for_upscale %}‚úÖ{% endif %}</td>
                <td>{% if rt.is_visible %}üëÅÔ∏è{% else %}üîí{% endif %}</td>
                <td>{{ rt.name }}</td>
                <td>{{ rt.generation_mode.replace('_', ' ') | title }}</td>
                <td>{{ rt.workflow_filename }}</td>
                <td>
                    {% if rt.prompt_examples %}
                    <details>
                        <summary>Show</summary>
                        <div class="details-box">
                            <p>{{ rt.prompt_examples }}</p>
                        </div>
                    </details>
                    {% else %}
                    N/A
                    {% endif %}
                </td>
                <td>
                    <button type="button" class="btn btn-secondary edit-btn" data-id="{{ rt.id }}"
                        data-name="{{ rt.name }}" data-workflow-filename="{{ rt.workflow_filename }}"
                        data-prompt-examples="{{ rt.prompt_examples or '' }}"
                        data-is-visible="{{ 'true' if rt.is_visible else 'false' }}"
                        data-generation-mode="{{ rt.generation_mode }}">Edit</button>

                    {% if rt.generation_mode == 'image_generation' and not rt.is_default_for_generation %}
                    <form action="/render-types/set-default/{{ rt.id }}/generation" method="post"
                        style="display: inline-block;">
                        <button type="submit" class="btn btn-secondary">Set Default (Gen)</button>
                    </form>
                    {% endif %}

                    {% if rt.generation_mode == 'upscale' and not rt.is_default_for_upscale %}
                    <form action="/render-types/set-default/{{ rt.id }}/upscale" method="post"
                        style="display: inline-block;">
                        <button type="submit" class="btn btn-secondary">Set Default (Upscale)</button>
                    </form>
                    {% endif %}

                    <form action="/render-types/delete/{{ rt.id }}" method="post"
                        onsubmit="return confirm('Are you sure you want to delete this item?');">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" style="text-align: center;">No render types found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="form-section">
        <h2 id="form-title">Add New Render Type</h2>
        <form id="render-type-form" action="/render-types/add" method="post">
            <div class="form-group"><label for="name">Render Type Name</label><input type="text" id="name" name="name"
                    required placeholder="e.g., SDXL_Photo"></div>
            <div class="form-group"><label for="generation_mode">Generation Mode</label><select id="generation_mode"
                    name="generation_mode" required>
                    <option value="image_generation" selected>Image Generation</option>
                    <option value="upscale">Upscale</option>
                </select></div>
            <div class="form-group"><label for="workflow_filename">Workflow Filename</label><input type="text"
                    id="workflow_filename" name="workflow_filename" required placeholder="e.g., sdxl_workflow.json">
            </div>
            <div class="form-group"><label for="prompt_examples">Prompt Examples (Optional)</label><textarea
                    id="prompt_examples" name="prompt_examples" rows="4"
                    placeholder="Provide one or more examples..."></textarea></div>
            <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="is_visible"
                        name="is_visible" value="true" checked> Visible to users</label></div>
            <button id="submit-btn" type="submit" class="btn btn-primary">Add Render Type</button>
            <button id="cancel-btn" type="button" class="btn btn-secondary" style="display: none;">Cancel</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById('render-type-form');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const nameInput = document.getElementById('name');
    const workflowInput = document.getElementById('workflow_filename');
    const examplesInput = document.getElementById('prompt_examples');
    const isVisibleInput = document.getElementById('is_visible');
    const generationModeInput = document.getElementById('generation_mode');

    function editRenderType(button) {
        form.action = `/render-types/update/${button.dataset.id}`;
        formTitle.textContent = 'Edit Render Type';
        submitBtn.textContent = 'Update Render Type';
        cancelBtn.style.display = 'inline-block';
        nameInput.value = button.dataset.name;
        workflowInput.value = button.dataset.workflowFilename;
        examplesInput.value = button.dataset.promptExamples;
        isVisibleInput.checked = button.dataset.isVisible === 'true';
        generationModeInput.value = button.dataset.generationMode;
        form.scrollIntoView({ behavior: 'smooth' });
    }

    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', () => editRenderType(button));
    });
    cancelBtn.addEventListener('click', () => {
        form.reset();
        form.action = '/render-types/add';
        formTitle.textContent = 'Add New Render Type';
        submitBtn.textContent = 'Add Render Type';
        cancelBtn.style.display = 'none';
    });
</script>
{% endblock %}