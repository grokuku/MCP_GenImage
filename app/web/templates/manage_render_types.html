{% extends "base.html" %}

{% block title %}{{ title }} - MCP GenImage{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ title }}</h1>

    <h2>Existing Render Types</h2>
    <table>
        <thead>
            <tr>
                <th>Default</th>
                <th>Visible</th>
                <th>Name</th>
                <th>Workflow Filename</th>
                <th>Prompt Examples</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for rt in render_types %}
            <tr>
                <td>
                    {% if rt.is_default %}
                    <span title="This is the default workflow">‚úÖ</span>
                    {% endif %}
                </td>
                <td>
                    {% if rt.is_visible %}
                    <span title="Visible to end users">üëÅÔ∏è</span>
                    {% else %}
                    <span title="Hidden from end users">üîí</span>
                    {% endif %}
                </td>
                <td>{{ rt.name }}</td>
                <td>{{ rt.workflow_filename }}</td>
                <td>
                    <pre style="white-space: pre-wrap; word-break: break-all;">{{ rt.prompt_examples or 'N/A' }}</pre>
                </td>
                <td>
                    <button type="button" class="btn btn-secondary edit-btn" data-id="{{ rt.id }}"
                        data-name="{{ rt.name }}" data-workflow-filename="{{ rt.workflow_filename }}"
                        data-prompt-examples="{{ rt.prompt_examples or '' }}"
                        data-is-visible="{{ 'true' if rt.is_visible else 'false' }}">Edit</button>

                    {% if not rt.is_default %}
                    <form action="/render-types/set-default/{{ rt.id }}" method="post" style="display: inline-block;">
                        <button type="submit" class="btn btn-secondary">Set as Default</button>
                    </form>
                    {% endif %}

                    <form action="/render-types/delete/{{ rt.id }}" method="post"
                        onsubmit="return confirm('Are you sure you want to delete this item?');">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align: center;">No render types found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="form-section">
        <h2 id="form-title">Add New Render Type</h2>
        <form id="render-type-form" action="/render-types/add" method="post">
            <div class="form-group">
                <label for="name">Render Type Name</label>
                <input type="text" id="name" name="name" required placeholder="e.g., SDXL_TURBO_UPSCALED">
            </div>
            <div class="form-group">
                <label for="workflow_filename">Workflow Filename</label>
                <input type="text" id="workflow_filename" name="workflow_filename" required
                    placeholder="e.g., upscale_workflow.json">
            </div>
            <div class="form-group">
                <label for="prompt_examples">Prompt Examples (Optional)</label>
                <textarea id="prompt_examples" name="prompt_examples" rows="4"
                    placeholder="Provide one or more examples of good prompts for this render type, separated by line breaks."></textarea>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="is_visible" name="is_visible" value="true" checked>
                    Visible to users (listed in the '/image' command)
                </label>
            </div>
            <button id="submit-btn" type="submit" class="btn btn-primary">Add Render Type</button>
            <button id="cancel-btn" type="button" class="btn btn-secondary" style="display: none;">Cancel</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById('render-type-form');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    const nameInput = document.getElementById('name');
    const workflowInput = document.getElementById('workflow_filename');
    const examplesInput = document.getElementById('prompt_examples');
    const isVisibleInput = document.getElementById('is_visible');

    function editRenderType(button) {
        const id = button.dataset.id;

        // Populate form fields
        form.action = `/render-types/update/${id}`;
        formTitle.textContent = 'Edit Render Type';
        submitBtn.textContent = 'Update Render Type';
        cancelBtn.style.display = 'inline-block';

        nameInput.value = button.dataset.name;
        workflowInput.value = button.dataset.workflowFilename;
        examplesInput.value = button.dataset.promptExamples;
        isVisibleInput.checked = button.dataset.isVisible === 'true';

        form.scrollIntoView({ behavior: 'smooth' });
    }

    function resetForm() {
        form.reset();
        form.action = '/render-types/add';
        formTitle.textContent = 'Add New Render Type';
        submitBtn.textContent = 'Add Render Type';
        cancelBtn.style.display = 'none';
    }

    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', () => editRenderType(button));
    });

    cancelBtn.addEventListener('click', resetForm);
</script>
{% endblock %}